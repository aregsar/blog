#test commands to build and run this dockerfile
#docker build . -f Dockerfile-app -t aregsar/phpfpm-prod
#docker run -p 9000:9000 aregsar/phpfpm-prod


#
# build stage 
#
FROM composer:1.6.3 AS build

WORKDIR /var/www

#only copy composer files so we won't install deps if other files change
COPY composer.json composer.lock ./

#composer autoloader needs to scan files in database directory
COPY database ./database

#create vendors directory and installs dependancies from composer.json
RUN composer install --no-dev --no-scripts --no-interaction

#copy all sources minus .dockerignore 
COPY ./ ./

#
# run stage
#
FROM php:7.2.2-fpm-alpine

#todo: should do this in build stage and copy installed file from there
RUN docker-php-ext-install pdo_mysql

WORKDIR /var/www

#copy over built application
COPY --from=build /var/www ./

#for some reaon after setting WORKDIR /var/www we are still in / root 
RUN chown -R www-data:www-data ./bootstrap/cache ./storage

EXPOSE 9000

CMD ["php-fpm"]