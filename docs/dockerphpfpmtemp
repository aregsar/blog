#test commands to build and run this dockerfile
#docker build . -f Dockerfile-app -t aregsar/phpfpm-prod
#docker run -p 9000:9000 aregsar/phpfpm-prod


#
# composer stage 
# to pull in the composer file installed in the official composer image
# instead of installing composer in the build stage image
#
FROM composer:1.6.3 AS composer

#
# build stage
#
FROM php:7.2.2-cli-stretch AS build

COPY --from=composer /usr/bin/composer /usr/bin/composer

#RUN composer --version && php --v

WORKDIR /var/www

COPY composer.lock composer.json ./

RUN composer install --no-dev --no-scripts --no-interaction

#
# run stage
#
FROM php:7.2.2-fpm-alpine

#todo: should do this in build stage and copy installed file from there
RUN docker-php-ext-install mcrypt mysqli pdo pdo_mysql openssl

WORKDIR /var/www

#copy all sources minus .dockerignore 
COPY . ./
COPY --from=build /var/www/vendor /var/www/vendor

#since public directory is ignored explicitly copy index.php
COPY public/index.php ./public/index.php

#allow app to write to cache and storage directories
RUN chown -R www-data:www-data ./bootstrap/cache ./storage

#RUN chgrp -R www-data ./storage ./bootstrap/cache && chmod -R ug+rwx ./storage ./bootstrap/cache